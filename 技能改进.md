# AI SSH FTP Proxy 技能改进建议

> 更新时间：2026-02-19 08:53

## 一、遇到的问题

### 问题 1：PowerShell 调用 API JSON 转义困难

**现象**：从 Windows PowerShell 通过 `curl.exe` 调用 API 时，JSON 中的双引号转义极其混乱。

```powershell
# 以下写法均无法正确传递 JSON：
curl.exe -X POST http://SERVER:48891/api/ssh/exec -H "Content-Type: application/json" -d "{`"command`": `"bHM=`"}"
# 结果：服务端返回 400 Bad Request —— invalid character 'c' looking for beginning of object key string
```

**根因**：PowerShell 对双引号的转义规则与 bash 不同，`"` 在 PowerShell 中需用 `` ` `` 转义，但 `curl.exe` 接收到的参数已被 PowerShell 处理过，JSON 格式被破坏。

**影响**：技能文档中所有示例命令均基于 Linux bash 语法，Windows 用户无法直接使用。

---

### 问题 2：PowerShell `Invoke-WebRequest` / `Invoke-RestMethod` 长时间挂起

**现象**：使用 PowerShell 原生 HTTP 客户端调用 API 时，请求发出后无响应，一直挂起直到超时。

```powershell
# 以下调用方式均挂起无响应：
Invoke-RestMethod -Uri "http://SERVER:48891/api/ssh/exec" -Method POST -ContentType "application/json" -Body $json
Invoke-WebRequest -Uri "http://SERVER:48891/api/ssh/exec" -Method POST -ContentType "application/json" -Body $json -TimeoutSec 60
```

**但同时**：`curl.exe -v` 可以成功连接并收到服务端响应（400），证明网络层是通的。

**可能原因**：
1. PowerShell HTTP 客户端发送的请求头或编码与 Go 服务端不兼容
2. 可能是 chunked transfer encoding 问题（PowerShell 默认分块传输，Go 服务端未正确处理）
3. 连接保持（Keep-Alive）行为差异导致响应未正确关闭

---

### 问题 3：缺乏 Windows PowerShell 的完整使用示例

**现象**：技能文档 SKILL.md 中仅有一个简单的 PowerShell 示例（Example 3），且未涵盖：
- JSON 转义的正确写法
- 响应解码的完整流程
- 错误处理

---

## 二、改进建议

### 建议 1：提供 Windows PowerShell 辅助脚本

在技能的 `scripts/` 目录下提供一个开箱即用的 `ssh_exec.ps1` 辅助脚本，封装好 JSON 构建、API 调用、Base64 编解码的完整逻辑，解决转义问题。

```powershell
# 期望的使用方式：
.\ssh_exec.ps1 -Command "ls -la /" -Server "http://SERVER:48891"
```

### 建议 2：服务端增加兼容性

- 支持 URL query 参数传递命令（避免 JSON body 转义问题）：`GET /api/ssh/exec?cmd=bHM=`
- 增加 chunked 请求体的支持
- 返回响应时确保 `Content-Length` 正确设置和连接正确关闭

### 建议 3：添加健康检查端点

增加 `GET /health` 端点，方便快速验证服务是否可达，不依赖 JSON body：

```bash
curl http://SERVER:48891/health
# {"status":"ok","version":"1.2.0"}
```

### 建议 4：文档补充 Windows 专用说明

在 SKILL.md 中新增 **Windows 使用指南** 章节，包含：
- PowerShell 中正确的 JSON 构造方式（使用 `ConvertTo-Json` 而非手写）
- 通过临时文件传递 JSON body 的方法（`-d @file.json`）
- 完整的调用+解码示例

---

## 三、临时解决方案

在上述改进完成前，可通过以下方式绕过：

### 方案 A：通过 SSH 直连执行（回退方案）

继续使用 OpenSSH 直连方式操作服务器，不依赖 HTTP API。

### 方案 B：通过临时文件传递 JSON

```powershell
$cmd = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes("ls -la /"))
@{command=$cmd} | ConvertTo-Json | Set-Content -Path cmd.json -Encoding UTF8
curl.exe -s -X POST http://SERVER:48891/api/ssh/exec -H "Content-Type: application/json" -d "@cmd.json"
```
