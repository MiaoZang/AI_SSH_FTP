import{d as Ce,k as f,J as N,o as xe,a as ee,e as l,w as t,E as d,g as i,l as ke,h as q,b as n,i as s,u as ze,K as $e,v as Ne,m as le,j as ae,t as p,p as Pe,x as Ue,q as te,_ as Fe}from"./index-x4DXS2Vx.js";import{a as k}from"./index-j8vyhiJM.js";import"./index-B9ygI19o.js";const De={class:"agent-management"},Se={class:"header-content"},Be={class:"action-section"},Te={class:"balance"},Ae={class:"text-muted"},Re={class:"pagination-container"},qe={class:"current-balance"},Ee={class:"bills-header"},Ke={class:"balance-info"},Me={key:0,class:"bills-pagination"},Le=Ce({__name:"AgentManagement",setup(je){const E=f(!1),c=f(!1),j=f([]),C=N({page:1,pageSize:20,total:0}),v=N({search:"",status:""}),P=f(!1),I=f(),b=N({username:"",displayName:"",password:""}),oe={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:2,max:50,message:"用户名长度 2-50 位",trigger:"blur"}],displayName:[{required:!0,message:"请输入显示名称",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,message:"密码至少 6 位",trigger:"blur"}]},U=f(!1),J=f(),w=f(null),x=N({password:"",confirmPassword:""}),se={password:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码至少 6 位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(o,e,z)=>{e!==x.password?z(new Error("两次密码不一致")):z()},trigger:"blur"}]},F=f(!1),G=f(),y=N({amount:100,description:""}),ne={amount:[{required:!0,message:"请输入充值金额",trigger:"blur"}]},D=f(!1),m=N({allowedPoolTypes:["0dollar","1dollar","2dollar"],priceConfig:{"0dollar":1,"1dollar":1,"2dollar":1}}),A=f(!1),K=f(!1),H=f([]),_=N({page:1,pageSize:10,total:0});async function V(){E.value=!0;try{const o={page:C.page,pageSize:C.pageSize};v.search&&(o.search=v.search),v.status&&(o.status=v.status);const e=await k.get("/agents",{params:o});j.value=e.data,C.total=e.pagination.total}catch(o){d.error(o.response?.data?.error||"获取代理列表失败")}finally{E.value=!1}}function re(){v.search="",v.status="",C.page=1,V()}function ie(){b.username="",b.displayName="",b.password="",P.value=!0}async function de(){if(await I.value?.validate().catch(()=>!1)){c.value=!0;try{await k.post("/agents",b),d.success("代理创建成功"),P.value=!1,V()}catch(e){d.error(e.response?.data?.error||"创建失败")}finally{c.value=!1}}}function ue(o){w.value=o,x.password="",x.confirmPassword="",U.value=!0}async function pe(){if(await J.value?.validate().catch(()=>!1)){c.value=!0;try{await k.put(`/agents/${w.value.id}/password`,{password:x.password}),d.success("密码修改成功"),U.value=!1}catch(e){d.error(e.response?.data?.error||"修改失败")}finally{c.value=!1}}}function me(o){w.value=o,y.amount=100,y.description="",F.value=!0}async function fe(){if(await G.value?.validate().catch(()=>!1)){if(y.amount===0){d.warning("请输入有效的充值金额");return}c.value=!0;try{await k.post(`/agents/${w.value.id}/recharge`,{amount:y.amount,description:y.description}),d.success(y.amount>0?"充值成功":"扣费成功"),F.value=!1,V()}catch(e){d.error(e.response?.data?.error||"操作失败")}finally{c.value=!1}}}async function ge(o){w.value=o,_.page=1,A.value=!0,await O()}async function O(){K.value=!0;try{const o=await k.get(`/agents/${w.value.id}/bills`,{params:{page:_.page,pageSize:_.pageSize}});H.value=o.data,_.total=o.pagination?.total||0}catch(o){d.error(o.response?.data?.error||"获取账单失败")}finally{K.value=!1}}function ce(o){w.value=o,m.allowedPoolTypes=o.allowedPoolTypes||["0dollar","1dollar","2dollar"],m.priceConfig=o.priceConfig||{"0dollar":1,"1dollar":1,"2dollar":1},D.value=!0}async function ve(){if(m.allowedPoolTypes.length===0){d.warning("请至少选择一种卡类型");return}c.value=!0;try{await k.put(`/agents/${w.value.id}/config`,{allowedPoolTypes:m.allowedPoolTypes,priceConfig:m.priceConfig}),d.success("配置更新成功"),D.value=!1,V()}catch(o){d.error(o.response?.data?.error||"更新失败")}finally{c.value=!1}}async function be(o){const e=o.status==="active"?"停用":"启用";try{await te.confirm(`确定要${e}代理 "${o.displayName}" 吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await k.put(`/agents/${o.id}/status`),d.success(`${e}成功`),V()}catch(z){z!=="cancel"&&d.error(z.response?.data?.error||"操作失败")}}async function we(o){try{await te.confirm(`确定要删除代理 "${o.displayName}" 吗？此操作不可恢复。`,"警告",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}),await k.delete(`/agents/${o.id}`),d.success("删除成功"),V()}catch(e){e!=="cancel"&&d.error(e.response?.data?.error||"删除失败")}}function Q(o){return o?new Date(o).toLocaleString("zh-CN"):"-"}return xe(()=>{V()}),(o,e)=>{const z=i("el-icon"),r=i("el-button"),M=i("el-card"),$=i("el-input"),u=i("el-form-item"),W=i("el-option"),ye=i("el-select"),S=i("el-form"),g=i("el-table-column"),X=i("el-tag"),Y=i("el-table"),Z=i("el-pagination"),B=i("el-dialog"),R=i("el-input-number"),L=i("el-checkbox"),Ve=i("el-checkbox-group"),_e=i("el-divider"),h=ke("loading");return q(),ee("div",De,[l(M,{class:"page-header"},{default:t(()=>[n("div",Se,[e[27]||(e[27]=n("div",{class:"title-section"},[n("h2",null,"代理管理"),n("span",{class:"subtitle"},"管理分销代理账户")],-1)),n("div",Be,[l(r,{type:"primary",onClick:ie},{default:t(()=>[l(z,null,{default:t(()=>[l(ze($e))]),_:1}),e[26]||(e[26]=s(" 新增代理 ",-1))]),_:1})])])]),_:1}),l(M,{class:"filter-card"},{default:t(()=>[l(S,{inline:!0,model:v,class:"filter-form"},{default:t(()=>[l(u,{label:"搜索"},{default:t(()=>[l($,{modelValue:v.search,"onUpdate:modelValue":e[0]||(e[0]=a=>v.search=a),placeholder:"用户名/显示名称",clearable:"",onKeyup:Ne(V,["enter"])},null,8,["modelValue"])]),_:1}),l(u,{label:"状态"},{default:t(()=>[l(ye,{modelValue:v.status,"onUpdate:modelValue":e[1]||(e[1]=a=>v.status=a),placeholder:"全部",clearable:""},{default:t(()=>[l(W,{label:"启用",value:"active"}),l(W,{label:"停用",value:"disabled"})]),_:1},8,["modelValue"])]),_:1}),l(u,null,{default:t(()=>[l(r,{type:"primary",onClick:V},{default:t(()=>[...e[28]||(e[28]=[s("搜索",-1)])]),_:1}),l(r,{onClick:re},{default:t(()=>[...e[29]||(e[29]=[s("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),l(M,{class:"table-card"},{default:t(()=>[le((q(),ae(Y,{data:j.value,stripe:""},{default:t(()=>[l(g,{prop:"username",label:"用户名",width:"120"}),l(g,{prop:"displayName",label:"显示名称",width:"150"}),l(g,{label:"余额",width:"120"},{default:t(({row:a})=>[n("span",Te,"¥"+p(Number(a.balance).toFixed(2)),1)]),_:1}),l(g,{label:"卡密统计",width:"150"},{default:t(({row:a})=>[n("span",null,"已创建: "+p(a.cardKeyCount||0),1),e[30]||(e[30]=n("br",null,null,-1)),n("span",Ae,"已使用: "+p(a.usedCardKeyCount||0),1)]),_:1}),l(g,{label:"状态",width:"100"},{default:t(({row:a})=>[l(X,{type:a.status==="active"?"success":"danger"},{default:t(()=>[s(p(a.status==="active"?"启用":"停用"),1)]),_:2},1032,["type"])]),_:1}),l(g,{label:"创建时间",width:"180"},{default:t(({row:a})=>[s(p(Q(a.createdAt)),1)]),_:1}),l(g,{label:"创建人",width:"120"},{default:t(({row:a})=>[s(p(a.createdBy?.displayName||a.createdBy?.username||"-"),1)]),_:1}),l(g,{label:"操作",width:"400",fixed:"right"},{default:t(({row:a})=>[l(r,{size:"small",type:"info",onClick:T=>ge(a)},{default:t(()=>[...e[31]||(e[31]=[s(" 账单 ",-1)])]),_:1},8,["onClick"]),l(r,{size:"small",type:"primary",onClick:T=>ce(a)},{default:t(()=>[...e[32]||(e[32]=[s(" 配置 ",-1)])]),_:1},8,["onClick"]),l(r,{size:"small",type:"success",onClick:T=>me(a)},{default:t(()=>[...e[33]||(e[33]=[s(" 充值 ",-1)])]),_:1},8,["onClick"]),l(r,{size:"small",onClick:T=>ue(a)},{default:t(()=>[...e[34]||(e[34]=[s(" 改密 ",-1)])]),_:1},8,["onClick"]),l(r,{size:"small",type:a.status==="active"?"warning":"success",onClick:T=>be(a)},{default:t(()=>[s(p(a.status==="active"?"停用":"启用"),1)]),_:2},1032,["type","onClick"]),l(r,{size:"small",type:"danger",onClick:T=>we(a)},{default:t(()=>[...e[35]||(e[35]=[s(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[h,E.value]]),n("div",Re,[l(Z,{"current-page":C.page,"onUpdate:currentPage":e[2]||(e[2]=a=>C.page=a),"page-size":C.pageSize,"onUpdate:pageSize":e[3]||(e[3]=a=>C.pageSize=a),"page-sizes":[10,20,50,100],total:C.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:V,onCurrentChange:V},null,8,["current-page","page-size","total"])])]),_:1}),l(B,{modelValue:P.value,"onUpdate:modelValue":e[8]||(e[8]=a=>P.value=a),title:"新增代理",width:"500px"},{footer:t(()=>[l(r,{onClick:e[7]||(e[7]=a=>P.value=!1)},{default:t(()=>[...e[36]||(e[36]=[s("取消",-1)])]),_:1}),l(r,{type:"primary",onClick:de,loading:c.value},{default:t(()=>[...e[37]||(e[37]=[s("创建",-1)])]),_:1},8,["loading"])]),default:t(()=>[l(S,{model:b,rules:oe,ref_key:"createFormRef",ref:I,"label-width":"100px"},{default:t(()=>[l(u,{label:"用户名",prop:"username"},{default:t(()=>[l($,{modelValue:b.username,"onUpdate:modelValue":e[4]||(e[4]=a=>b.username=a),placeholder:"代理登录用户名"},null,8,["modelValue"])]),_:1}),l(u,{label:"显示名称",prop:"displayName"},{default:t(()=>[l($,{modelValue:b.displayName,"onUpdate:modelValue":e[5]||(e[5]=a=>b.displayName=a),placeholder:"代理显示名称"},null,8,["modelValue"])]),_:1}),l(u,{label:"初始密码",prop:"password"},{default:t(()=>[l($,{modelValue:b.password,"onUpdate:modelValue":e[6]||(e[6]=a=>b.password=a),type:"password","show-password":"",placeholder:"至少6位"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(B,{modelValue:U.value,"onUpdate:modelValue":e[12]||(e[12]=a=>U.value=a),title:"修改密码",width:"400px"},{footer:t(()=>[l(r,{onClick:e[11]||(e[11]=a=>U.value=!1)},{default:t(()=>[...e[38]||(e[38]=[s("取消",-1)])]),_:1}),l(r,{type:"primary",onClick:pe,loading:c.value},{default:t(()=>[...e[39]||(e[39]=[s("确认",-1)])]),_:1},8,["loading"])]),default:t(()=>[l(S,{model:x,rules:se,ref_key:"passwordFormRef",ref:J,"label-width":"100px"},{default:t(()=>[l(u,{label:"新密码",prop:"password"},{default:t(()=>[l($,{modelValue:x.password,"onUpdate:modelValue":e[9]||(e[9]=a=>x.password=a),type:"password","show-password":"",placeholder:"至少6位"},null,8,["modelValue"])]),_:1}),l(u,{label:"确认密码",prop:"confirmPassword"},{default:t(()=>[l($,{modelValue:x.confirmPassword,"onUpdate:modelValue":e[10]||(e[10]=a=>x.confirmPassword=a),type:"password","show-password":"",placeholder:"再次输入密码"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(B,{modelValue:F.value,"onUpdate:modelValue":e[16]||(e[16]=a=>F.value=a),title:"代理充值",width:"400px"},{footer:t(()=>[l(r,{onClick:e[15]||(e[15]=a=>F.value=!1)},{default:t(()=>[...e[41]||(e[41]=[s("取消",-1)])]),_:1}),l(r,{type:"primary",onClick:fe,loading:c.value},{default:t(()=>[...e[42]||(e[42]=[s("充值",-1)])]),_:1},8,["loading"])]),default:t(()=>[l(S,{model:y,rules:ne,ref_key:"rechargeFormRef",ref:G,"label-width":"100px"},{default:t(()=>[l(u,{label:"当前余额"},{default:t(()=>[n("span",qe,"¥"+p(Number(w.value?.balance||0).toFixed(2)),1)]),_:1}),l(u,{label:"充值/扣费",prop:"amount"},{default:t(()=>[l(R,{modelValue:y.amount,"onUpdate:modelValue":e[13]||(e[13]=a=>y.amount=a),min:-1e5,max:1e5,step:100},null,8,["modelValue"]),e[40]||(e[40]=n("div",{class:"tip"},"正数为充值，负数为扣费",-1))]),_:1}),l(u,{label:"备注"},{default:t(()=>[l($,{modelValue:y.description,"onUpdate:modelValue":e[14]||(e[14]=a=>y.description=a),placeholder:"可选"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(B,{modelValue:D.value,"onUpdate:modelValue":e[22]||(e[22]=a=>D.value=a),title:"代理配置",width:"500px"},{footer:t(()=>[l(r,{onClick:e[21]||(e[21]=a=>D.value=!1)},{default:t(()=>[...e[50]||(e[50]=[s("取消",-1)])]),_:1}),l(r,{type:"primary",onClick:ve,loading:c.value},{default:t(()=>[...e[51]||(e[51]=[s("保存配置",-1)])]),_:1},8,["loading"])]),default:t(()=>[l(S,{model:m,"label-width":"120px"},{default:t(()=>[l(u,{label:"可用卡类型"},{default:t(()=>[l(Ve,{modelValue:m.allowedPoolTypes,"onUpdate:modelValue":e[17]||(e[17]=a=>m.allowedPoolTypes=a)},{default:t(()=>[l(L,{label:"0dollar"},{default:t(()=>[...e[43]||(e[43]=[s("$0 卡",-1)])]),_:1}),l(L,{label:"1dollar"},{default:t(()=>[...e[44]||(e[44]=[s("$1 卡",-1)])]),_:1}),l(L,{label:"2dollar"},{default:t(()=>[...e[45]||(e[45]=[s("$2 卡",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(_e,{"content-position":"left"},{default:t(()=>[...e[46]||(e[46]=[s("各类型单价设置",-1)])]),_:1}),l(u,{label:"$0 卡单价"},{default:t(()=>[l(R,{modelValue:m.priceConfig["0dollar"],"onUpdate:modelValue":e[18]||(e[18]=a=>m.priceConfig["0dollar"]=a),min:0,max:1e3,step:.1,precision:2},null,8,["modelValue"]),e[47]||(e[47]=n("span",{class:"price-unit"},"元/张",-1))]),_:1}),l(u,{label:"$1 卡单价"},{default:t(()=>[l(R,{modelValue:m.priceConfig["1dollar"],"onUpdate:modelValue":e[19]||(e[19]=a=>m.priceConfig["1dollar"]=a),min:0,max:1e3,step:.1,precision:2},null,8,["modelValue"]),e[48]||(e[48]=n("span",{class:"price-unit"},"元/张",-1))]),_:1}),l(u,{label:"$2 卡单价"},{default:t(()=>[l(R,{modelValue:m.priceConfig["2dollar"],"onUpdate:modelValue":e[20]||(e[20]=a=>m.priceConfig["2dollar"]=a),min:0,max:1e3,step:.1,precision:2},null,8,["modelValue"]),e[49]||(e[49]=n("span",{class:"price-unit"},"元/张",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(B,{modelValue:A.value,"onUpdate:modelValue":e[25]||(e[25]=a=>A.value=a),title:"代理账单",width:"700px"},{footer:t(()=>[l(r,{onClick:e[24]||(e[24]=a=>A.value=!1)},{default:t(()=>[...e[52]||(e[52]=[s("关闭",-1)])]),_:1})]),default:t(()=>[n("div",Ee,[n("span",null,"代理："+p(w.value?.displayName),1),n("span",Ke,"当前余额：¥"+p(Number(w.value?.balance||0).toFixed(2)),1)]),le((q(),ae(Y,{data:H.value,stripe:"","max-height":"400"},{default:t(()=>[l(g,{label:"类型",width:"80"},{default:t(({row:a})=>[l(X,{type:a.type==="recharge"?"success":"danger",size:"small"},{default:t(()=>[s(p(a.type==="recharge"?"充值":"扣费"),1)]),_:2},1032,["type"])]),_:1}),l(g,{label:"金额",width:"100"},{default:t(({row:a})=>[n("span",{class:Ue(a.type==="recharge"?"text-success":"text-danger")},p(a.type==="recharge"?"+":"")+p(Number(a.amount).toFixed(2)),3)]),_:1}),l(g,{label:"变动后余额",width:"120"},{default:t(({row:a})=>[s(" ¥"+p(Number(a.balance).toFixed(2)),1)]),_:1}),l(g,{prop:"description",label:"描述","show-overflow-tooltip":""}),l(g,{label:"时间",width:"180"},{default:t(({row:a})=>[s(p(Q(a.createdAt)),1)]),_:1})]),_:1},8,["data"])),[[h,K.value]]),_.total>_.pageSize?(q(),ee("div",Me,[l(Z,{"current-page":_.page,"onUpdate:currentPage":e[23]||(e[23]=a=>_.page=a),"page-size":_.pageSize,total:_.total,layout:"prev, pager, next",onCurrentChange:O},null,8,["current-page","page-size","total"])])):Pe("",!0)]),_:1},8,["modelValue"])])}}}),Oe=Fe(Le,[["__scopeId","data-v-f56d27ac"]]);export{Oe as default};
