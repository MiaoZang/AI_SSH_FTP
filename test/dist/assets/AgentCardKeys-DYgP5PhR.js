import{d as ce,k as _,J as K,c as U,o as fe,a as S,e as l,w as a,E as k,g as i,l as ge,h as v,b as n,i as s,u as G,K as me,v as ye,m as _e,j as P,t as u,H as ve,p as D,F as be,r as Ce,q as Te,_ as we}from"./index-x4DXS2Vx.js";import{a as z}from"./agentApi-CTrSVxho.js";import"./index-B9ygI19o.js";const ke={class:"agent-card-keys"},Ve={class:"header-content"},xe={class:"action-section"},Se={class:"key-code"},Ae={key:0},$e={key:1,class:"text-muted"},Ke={class:"pagination-container"},Pe={key:0,class:"no-type-tip"},ze={class:"price"},Ne={class:"total-cost"},Be={class:"result-info"},Ie={class:"deduct"},he={class:"balance"},Ue=ce({__name:"AgentCardKeys",setup(De){const T=_(!1),N=_(!1),J=_([]),f=K({page:1,pageSize:20,total:0}),r=K({search:"",status:"",poolType:""}),V=_(!1),F=_(),p=K({poolType:"0dollar",count:10}),H={poolType:[{required:!0,message:"请选择卡密类型"}],count:[{required:!0,message:"请输入数量"}]},g=K({allowedPoolTypes:["0dollar","1dollar","2dollar"],priceConfig:{"0dollar":1,"1dollar":1,"2dollar":1}}),A=U(()=>{const o={"0dollar":"$0 卡密 (AAA0)","1dollar":"$1 卡密 (AAA1)","2dollar":"$2 卡密 (AAA2)"};return g.allowedPoolTypes.filter(e=>e!=="self_created").map(e=>({value:e,label:o[e]||e}))}),B=U(()=>g.priceConfig[p.poolType]||1);function Q(){const o=localStorage.getItem("agent_info");if(o)try{const e=JSON.parse(o);e.allowedPoolTypes&&(g.allowedPoolTypes=e.allowedPoolTypes),e.priceConfig&&(g.priceConfig=e.priceConfig)}catch(e){console.error("加载代理配置失败",e)}}const $=_(!1),I=_([]),O=_(0),E=_(0),h=U(()=>I.value.map(o=>o.keyCode).join(`
`));async function b(){T.value=!0;try{const o={page:f.page,pageSize:f.pageSize};r.search&&(o.search=r.search),r.status&&(o.status=r.status),r.poolType&&(o.poolType=r.poolType);const e=await z.get("/agent/card-keys",{params:o});J.value=e.data.data,f.total=e.data.pagination.total}catch(o){k.error(o.response?.data?.error||"获取卡密列表失败")}finally{T.value=!1}}function W(){r.search="",r.status="",r.poolType="",f.page=1,b()}async function X(){T.value=!0;try{const e=(await z.get("/agent/config")).data;g.allowedPoolTypes=e.allowedPoolTypes||["0dollar","1dollar","2dollar"],g.priceConfig=e.priceConfig||{"0dollar":1,"1dollar":1,"2dollar":1};const c=localStorage.getItem("agent_info");if(c){const y=JSON.parse(c);y.allowedPoolTypes=g.allowedPoolTypes,y.priceConfig=g.priceConfig,localStorage.setItem("agent_info",JSON.stringify(y))}const m=A.value[0];p.poolType=m?m.value:"0dollar",p.count=10,V.value=!0}catch(o){k.error(o.response?.data?.error||"获取实时配置失败")}finally{T.value=!1}}async function Y(){if(await F.value?.validate().catch(()=>!1)){N.value=!0;try{const e=await z.post("/agent/card-keys/generate",{poolType:p.poolType,count:p.count,pricePerKey:B.value});I.value=e.data.cardKeys,O.value=e.data.totalCost,E.value=Number(e.data.newBalance),V.value=!1,$.value=!0;const c=localStorage.getItem("agent_info");if(c){const d=JSON.parse(c);d.balance=e.data.newBalance,localStorage.setItem("agent_info",JSON.stringify(d))}b()}catch(e){k.error(e.response?.data?.error||"生成失败")}finally{N.value=!1}}}function Z(o){navigator.clipboard.writeText(o),k.success("已复制")}function ee(){navigator.clipboard.writeText(h.value),k.success("已复制全部卡密")}async function le(o){try{await Te.confirm(`确定要注销此卡密吗？
注销后将自动退款 ¥${o.price||g.priceConfig[o.poolType]||0} 到您的余额。`,"注销确认",{confirmButtonText:"确认注销",cancelButtonText:"取消",type:"warning"}),T.value=!0;const e=await z.post("/agent/card-keys/cancel",{id:o.id}),{refundAmount:c,newBalance:d}=e.data;k.success(`注销成功，已退还 ¥${c}，当前余额 ¥${d}`);const m=localStorage.getItem("agent_info");if(m){const y=JSON.parse(m);y.balance=d,localStorage.setItem("agent_info",JSON.stringify(y))}b()}catch(e){e!=="cancel"&&k.error(e.response?.data?.error||"注销失败")}finally{T.value=!1}}function te(o){return o?o.replace(/(\d{4})/g,"$1 ").trim():"-"}function ae(o){return{"0dollar":"$0","1dollar":"$1","2dollar":"$2",self_created:"自开卡"}[o]||o}function oe(o){return{"0dollar":"info","1dollar":"warning","2dollar":"success"}[o]||""}function M(o){return o?new Date(o).toLocaleString("zh-CN"):"-"}return fe(()=>{Q(),b()}),(o,e)=>{const c=i("el-icon"),d=i("el-button"),m=i("el-card"),y=i("el-input"),C=i("el-form-item"),x=i("el-option"),j=i("el-select"),q=i("el-form"),w=i("el-table-column"),L=i("el-tag"),ne=i("el-table"),se=i("el-pagination"),re=i("el-radio-button"),de=i("el-radio-group"),ie=i("el-input-number"),R=i("el-dialog"),ue=ge("loading");return v(),S("div",ke,[l(m,{class:"page-header"},{default:a(()=>[n("div",Ve,[e[13]||(e[13]=n("div",{class:"title-section"},[n("h2",null,"卡密管理 2026年1月28日01:05:57"),n("span",{class:"subtitle"},"生成和管理您的卡密")],-1)),n("div",xe,[l(d,{type:"primary",onClick:X},{default:a(()=>[l(c,null,{default:a(()=>[l(G(me))]),_:1}),e[12]||(e[12]=s(" 生成卡密 ",-1))]),_:1})])])]),_:1}),l(m,{class:"filter-card"},{default:a(()=>[l(q,{inline:!0,model:r,class:"filter-form"},{default:a(()=>[l(C,{label:"搜索"},{default:a(()=>[l(y,{modelValue:r.search,"onUpdate:modelValue":e[0]||(e[0]=t=>r.search=t),placeholder:"搜索卡密或已绑定的卡号",clearable:"",style:{width:"250px"},onKeyup:ye(b,["enter"])},null,8,["modelValue"])]),_:1}),l(C,{label:"状态"},{default:a(()=>[l(j,{modelValue:r.status,"onUpdate:modelValue":e[1]||(e[1]=t=>r.status=t),placeholder:"全部",clearable:""},{default:a(()=>[l(x,{label:"未使用",value:"unused"}),l(x,{label:"已激活",value:"activated"})]),_:1},8,["modelValue"])]),_:1}),l(C,{label:"类型"},{default:a(()=>[l(j,{modelValue:r.poolType,"onUpdate:modelValue":e[2]||(e[2]=t=>r.poolType=t),placeholder:"全部",clearable:""},{default:a(()=>[l(x,{label:"$0 卡",value:"0dollar"}),l(x,{label:"$1 卡",value:"1dollar"}),l(x,{label:"$2 卡",value:"2dollar"})]),_:1},8,["modelValue"])]),_:1}),l(C,null,{default:a(()=>[l(d,{type:"primary",onClick:b},{default:a(()=>[...e[14]||(e[14]=[s("搜索",-1)])]),_:1}),l(d,{onClick:W},{default:a(()=>[...e[15]||(e[15]=[s("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),l(m,{class:"table-card"},{default:a(()=>[_e((v(),P(ne,{data:J.value,stripe:""},{default:a(()=>[l(w,{prop:"keyCode",label:"卡密",width:"220"},{default:a(({row:t})=>[n("div",Se,[n("span",null,u(t.keyCode),1),l(d,{size:"small",text:"",onClick:pe=>Z(t.keyCode)},{default:a(()=>[l(c,null,{default:a(()=>[l(G(ve))]),_:1})]),_:1},8,["onClick"])])]),_:1}),l(w,{label:"类型",width:"100"},{default:a(({row:t})=>[l(L,{type:oe(t.poolType)},{default:a(()=>[s(u(ae(t.poolType)),1)]),_:2},1032,["type"])]),_:1}),l(w,{label:"状态",width:"100"},{default:a(({row:t})=>[l(L,{type:t.status==="unused"?"info":"success"},{default:a(()=>[s(u(t.status==="unused"?"未使用":"已激活"),1)]),_:2},1032,["type"])]),_:1}),l(w,{label:"绑定卡号",width:"180"},{default:a(({row:t})=>[t.poolCard?(v(),S("span",Ae,u(te(t.poolCard.pan)),1)):(v(),S("span",$e,"-"))]),_:1}),l(w,{label:"创建时间",width:"180"},{default:a(({row:t})=>[s(u(M(t.createdAt)),1)]),_:1}),l(w,{label:"激活时间",width:"180"},{default:a(({row:t})=>[s(u(t.activatedAt?M(t.activatedAt):"-"),1)]),_:1}),l(w,{label:"操作",width:"100",fixed:"right"},{default:a(({row:t})=>[t.status==="unused"?(v(),P(d,{key:0,type:"danger",size:"small",text:"",onClick:pe=>le(t)},{default:a(()=>[...e[16]||(e[16]=[s(" 注销 ",-1)])]),_:1},8,["onClick"])):D("",!0)]),_:1})]),_:1},8,["data"])),[[ue,T.value]]),n("div",Ke,[l(se,{"current-page":f.page,"onUpdate:currentPage":e[3]||(e[3]=t=>f.page=t),"page-size":f.pageSize,"onUpdate:pageSize":e[4]||(e[4]=t=>f.pageSize=t),"page-sizes":[10,20,50,100],total:f.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:b,onCurrentChange:b},null,8,["current-page","page-size","total"])])]),_:1}),l(R,{modelValue:V.value,"onUpdate:modelValue":e[8]||(e[8]=t=>V.value=t),title:"生成卡密",width:"500px"},{footer:a(()=>[l(d,{onClick:e[7]||(e[7]=t=>V.value=!1)},{default:a(()=>[...e[17]||(e[17]=[s("取消",-1)])]),_:1}),l(d,{type:"primary",onClick:Y,loading:N.value},{default:a(()=>[...e[18]||(e[18]=[s(" 确认生成 ",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(q,{model:p,rules:H,ref_key:"generateFormRef",ref:F,"label-width":"100px"},{default:a(()=>[A.value.length>1?(v(),P(C,{key:0,label:"卡密类型",prop:"poolType"},{default:a(()=>[l(de,{modelValue:p.poolType,"onUpdate:modelValue":e[5]||(e[5]=t=>p.poolType=t)},{default:a(()=>[(v(!0),S(be,null,Ce(A.value,t=>(v(),P(re,{key:t.value,value:t.value},{default:a(()=>[s(u(t.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"]),A.value.length===0?(v(),S("div",Pe," 管理员未配置可用卡类型 ")):D("",!0)]),_:1})):D("",!0),l(C,{label:"生成数量",prop:"count"},{default:a(()=>[l(ie,{modelValue:p.count,"onUpdate:modelValue":e[6]||(e[6]=t=>p.count=t),min:1,max:100},null,8,["modelValue"])]),_:1}),l(C,{label:"单价"},{default:a(()=>[n("span",ze,"¥"+u(B.value)+" / 张",1)]),_:1}),l(C,{label:"总计"},{default:a(()=>[n("span",Ne,"¥"+u((p.count*B.value).toFixed(2)),1)]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(R,{modelValue:$.value,"onUpdate:modelValue":e[11]||(e[11]=t=>$.value=t),title:"生成成功",width:"600px"},{footer:a(()=>[l(d,{onClick:ee},{default:a(()=>[...e[23]||(e[23]=[s("复制全部卡密",-1)])]),_:1}),l(d,{type:"primary",onClick:e[10]||(e[10]=t=>$.value=!1)},{default:a(()=>[...e[24]||(e[24]=[s("关闭",-1)])]),_:1})]),default:a(()=>[n("div",Be,[n("p",null,[e[19]||(e[19]=s("成功生成 ",-1)),n("strong",null,u(I.value.length),1),e[20]||(e[20]=s(" 张卡密",-1))]),n("p",null,[e[21]||(e[21]=s("扣款：",-1)),n("strong",Ie,"¥"+u(O.value),1)]),n("p",null,[e[22]||(e[22]=s("剩余余额：",-1)),n("strong",he,"¥"+u(E.value),1)])]),l(y,{modelValue:h.value,"onUpdate:modelValue":e[9]||(e[9]=t=>h.value=t),type:"textarea",rows:10,readonly:"",class:"keys-textarea"},null,8,["modelValue"])]),_:1},8,["modelValue"])])}}}),Ee=we(Ue,[["__scopeId","data-v-52cab418"]]);export{Ee as default};
