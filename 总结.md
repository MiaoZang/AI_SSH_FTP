# SSH/FTP 代理服务方案总结

## 需求概述

构建一个基于Go的SSH/FTP代理服务，作为AI Agent的技能模块使用。

### 核心需求

**1. SSH服务**
- 支持免密认证（密钥/密码预配置）
- 执行远程Shell命令
- 返回结构化的执行结果（stdout、stderr、exit code）

**2. FTP服务**
- 支持免密认证
- 执行FTP操作（上传、下载、列表等）
- 返回操作结果和状态信息

### 设计目标

- **技术栈**：使用Go语言编译为独立二进制
- **部署方式**：独立服务器进程（支持一键启停脚本）
- **交互接口**：HTTP RESTful API + WebSocket（高性能通讯）
- **服务对象**：AI Agent通过API调用
- **使用场景**：临时测试调试环境，快速启停，轻量级部署

---

## 方案优势

### 1. 简化AI交互
- AI无需处理SSH/FTP底层协议细节
- 避免处理交互式会话（密码输入、终端控制字符等）
- 统一的HTTP接口，易于集成到各类AI系统

### 2. 安全性可控
- 凭证集中管理在服务端
- 可实现细粒度的权限控制和审计
- AI无需直接持有敏感凭证

### 3. 结果可靠获取
- 结构化的JSON返回格式
- 完整捕获命令输出（stdout、stderr）
- 统一的超时控制和错误处理机制

### 4. 突破限制
- 绕过传统SSH/FTP客户端的交互限制
- 支持批量操作和并发执行
- 可扩展自定义功能

---

## 架构建议

### API接口设计

#### HTTP RESTful 接口

```
SSH 相关：
POST   /api/ssh/exec       - 执行命令（核心接口，支持Base64编码）
POST   /api/ssh/upload     - 上传文件
POST   /api/ssh/download   - 下载文件

FTP 相关：
POST   /api/ftp/upload     - 上传文件
POST   /api/ftp/download   - 下载文件
POST   /api/ftp/list       - 列出目录（支持Base64编码路径）
POST   /api/ftp/delete     - 删除文件
POST   /api/ftp/mkdir      - 创建目录

系统接口：
GET    /api/health         - 健康检查
GET    /api/diag           - 诊断接口（日志导出）
```

#### WebSocket 接口（高性能通讯）

```
WS     /ws/ssh             - SSH交互式会话（实时命令执行）
WS     /ws/ftp             - FTP会话（实时文件操作）
WS     /ws/stream          - 流式数据传输（大文件、实时日志）
```

> **通讯协议选择**
> - **HTTP**：适用于单次命令执行、文件传输等请求-响应模式
> - **WebSocket**：适用于交互式会话、实时输出、长时间运行的任务

### 请求/响应示例

#### SSH执行命令（Base64编码方案）

**方案说明**：为确保复杂命令（包含特殊字符、管道、重定向等）的准确传输，**强烈建议使用Base64编码**。

```json
// 请求（简单命令 - 可选编码）
POST /api/ssh/exec
{
  "server": "server1",
  "command": "df -h",
  "encoding": "plain",
  "timeout": 30
}

// 请求（复杂命令 - Base64编码）
POST /api/ssh/exec
{
  "server": "server1",
  "command": "ZmluZCAvcGF0aCAtbmFtZSAiKi5sb2ciIHwgZ3JlcCAiZXJyb3IiID4gL3RtcC9yZXN1bHQudHh0",
  // Base64编码前: find /path -name "*.log" | grep "error" > /tmp/result.txt
  "encoding": "base64",
  "timeout": 30
}

// 响应（stdout/stderr 也使用Base64编码返回，避免特殊字符问题）
{
  "success": true,
  "exit_code": 0,
  "stdout": "RmlsZXN5c3RlbSAgICAgIFNpemUgIFVzZWQgQXZhaWwgVXNlJSBNb3VudGVkIG9uLi4u",
  "stderr": "",
  "encoding": "base64",
  "execution_time": 1.23,
  "timestamp": "2026-01-17T23:29:00+08:00"
}
```

**编码优势**：
- ✅ 确保特殊字符不被转义或丢失
- ✅ 支持包含引号、管道、重定向的复杂命令
- ✅ 避免JSON转义问题
- ✅ 二进制数据也能安全传输

#### FTP操作示例（同样支持Base64编码路径）

```json
// 请求
POST /api/ftp/list
{
  "server": "ftp1",
  "path": "L+S4reaWh+mrmOW6pw==",  // Base64: "/中文路径"
  "encoding": "base64"
}
```

---

## 安全与部署策略

### 使用场景定位

> **重要说明**：本项目定位为**临时测试调试工具**，主要用于开发、测试环境，追求快速启停和易用性。

### 安全策略（简化版）

**基础安全措施**（可选）：
- **简单认证**：可选的API Key认证（环境变量配置）
- **基础日志**：记录操作日志便于调试
- **环境隔离**：建议仅在内网或测试环境使用

**不实现的复杂功能**：
- ❌ 不需要HTTPS（测试环境）
- ❌ 不需要IP白名单
- ❌ 不需要速率限制
- ❌ 不需要命令白名单/黑名单（完全信任调用方）
- ❌ 不需要复杂的审计系统

### 部署管理

#### 一键启停脚本

**start.sh**（启动脚本）
```bash
#!/bin/bash
# 启动SSH/FTP代理服务

cd "$(dirname "$0")"

# 检查是否已运行
if [ -f "server.pid" ]; then
    PID=$(cat server.pid)
    if ps -p $PID > /dev/null 2>&1; then
        echo "服务已在运行 (PID: $PID)"
        exit 1
    fi
fi

# 启动服务
echo "正在启动服务..."
nohup ./ssh-ftp-proxy > server.log 2>&1 &
echo $! > server.pid
echo "服务已启动 (PID: $(cat server.pid))"
echo "日志文件: server.log"
```

**stop.sh**（停止脚本）
```bash
#!/bin/bash
# 停止SSH/FTP代理服务

cd "$(dirname "$0")"

if [ ! -f "server.pid" ]; then
    echo "未找到PID文件，服务可能未运行"
    exit 1
fi

PID=$(cat server.pid)

if ps -p $PID > /dev/null 2>&1; then
    echo "正在停止服务 (PID: $PID)..."
    kill $PID
    sleep 1
    
    # 如果还在运行，强制杀死
    if ps -p $PID > /dev/null 2>&1; then
        echo "强制终止服务..."
        kill -9 $PID
    fi
    
    rm server.pid
    echo "服务已停止"
else
    echo "服务未运行 (PID: $PID 不存在)"
    rm server.pid
fi
```

**status.sh**（状态检查）
```bash
#!/bin/bash
# 检查服务状态

cd "$(dirname "$0")"

if [ ! -f "server.pid" ]; then
    echo "状态: 未运行"
    exit 0
fi

PID=$(cat server.pid)

if ps -p $PID > /dev/null 2>&1; then
    echo "状态: 运行中 (PID: $PID)"
    echo "端口监听:"
    netstat -tulpn 2>/dev/null | grep $PID || ss -tulpn | grep $PID
    echo "内存使用:"
    ps -p $PID -o pid,rss,vsz,cmd
else
    echo "状态: 未运行 (PID文件存在但进程不存在)"
    rm server.pid
fi
```

**使用方式**：
```bash
chmod +x *.sh
./start.sh    # 启动服务
./status.sh   # 查看状态
./stop.sh     # 停止服务
```

---

## 技术栈推荐

### 核心依赖

```go
// HTTP框架（选其一）
github.com/gin-gonic/gin         // 高性能，生态丰富
github.com/labstack/echo/v4      // 简洁，中间件丰富

// WebSocket库
github.com/gorilla/websocket     // 成熟的WebSocket实现
// 注：Gin和Echo都有内置WebSocket支持

// SSH库
golang.org/x/crypto/ssh          // 官方SSH实现

// FTP库
github.com/jlaffaye/ftp          // 成熟的FTP客户端

// 配置管理
github.com/spf13/viper           // 支持多种配置格式

// 日志
go.uber.org/zap                  // 高性能结构化日志
github.com/sirupsen/logrus       // 功能丰富的日志库

// 其他工具
github.com/pkg/sftp              // SFTP支持
github.com/google/uuid           // 生成请求ID
```

### 项目结构

```
AI_SSH_FTP/
├── cmd/
│   └── server/
│       └── main.go              // 入口文件
├── internal/
│   ├── config/                  // 配置管理
│   ├── handler/
│   │   ├── http/                // HTTP处理器
│   │   └── websocket/           // WebSocket处理器
│   ├── service/
│   │   ├── ssh/                 // SSH服务
│   │   └── ftp/                 // FTP服务
│   ├── middleware/              // 中间件（认证、日志等）
│   ├── encoder/                 // Base64编解码工具
│   └── model/                   // 数据模型
├── config/
│   └── config.yaml              // 配置文件
├── scripts/
│   ├── start.sh                 // 启动脚本
│   ├── stop.sh                  // 停止脚本
│   ├── status.sh                // 状态检查脚本
│   └── install.sh               // 安装脚本
├── go.mod
├── go.sum
└── README.md
```

---

## 核心功能特性

### 1. 命令编码处理（重点功能）⭐

**Base64编码方案**：
- **编码端**（AI Agent）：
  ```go
  command := `find /path -name "*.log" | grep "error" > /tmp/result.txt`
  encoded := base64.StdEncoding.EncodeToString([]byte(command))
  ```
  
- **解码端**（Go服务）：
  ```go
  decoded, _ := base64.StdEncoding.DecodeString(request.Command)
  actualCommand := string(decoded)
  ```

- **适用场景**：
  - 复杂Shell命令（管道、重定向）
  - 包含特殊字符的命令
  - 中文路径或文件名
  - FTP路径处理

### 2. WebSocket实时通讯（重点功能）⭐

**实现优势**：
- **低延迟**：双向实时通讯，适合交互式命令
- **流式输出**：命令执行时实时返回输出
- **长连接**：避免HTTP短连接开销
- **事件驱动**：支持服务端主动推送

**使用场景**：
- 交互式Shell会话（类似SSH终端）
- 长时间运行的命令（实时查看进度）
- 文件传输进度监控
- 日志实时流式传输

**WebSocket消息协议示例**：
```json
// 客户端 -> 服务端
{
  "type": "ssh.exec",
  "payload": {
    "server": "server1",
    "command": "dGFpbCAtZiAvdmFyL2xvZy9zeXNsb2c=",  // Base64编码
    "stream": true  // 流式返回
  }
}

// 服务端 -> 客户端（实时流式输出）
{
  "type": "ssh.stdout",
  "payload": {
    "data": "TG9nIGxpbmUgMS4uLg==",  // Base64编码的输出
    "timestamp": "2026-01-17T23:36:00+08:00"
  }
}
```

### 3. 连接池管理
- **SSH连接池**：复用SSH连接，避免频繁建立
- **超时清理**：自动清理空闲连接
- **连接健康检查**：定期检查连接可用性

### 4. 文件传输优化
- **断点续传**：支持大文件传输中断后继续
- **分块传输**：大文件分块上传/下载
- **进度回调**：通过WebSocket实时返回传输进度
- **压缩传输**：支持文件压缩后传输

### 5. 多目标支持
- **服务器配置**：支持配置多个SSH/FTP服务器
- **动态切换**：API请求时指定目标服务器
- **跳板机支持**：支持通过跳板机连接目标服务器

---

## 快速部署指南（测试环境）

### 1. 编译与部署
```bash
# 编译（在开发机）
cd AI_SSH_FTP
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o ssh-ftp-proxy cmd/server/main.go

# 上传到服务器（T盘）
scp ssh-ftp-proxy user@server:/t/ssh-ftp-proxy/
scp scripts/*.sh user@server:/t/ssh-ftp-proxy/
scp config/config.yaml user@server:/t/ssh-ftp-proxy/

# 服务器上配置
cd /t/ssh-ftp-proxy
chmod +x ssh-ftp-proxy
chmod +x *.sh
```

### 2. 配置文件示例
```yaml
# config.yaml
server:
  http_port: 8080         # HTTP端口
  ws_port: 8081           # WebSocket端口
  bind_ip: "0.0.0.0"      # 显式绑定IP

ssh_servers:
  server1:
    host: "192.168.1.100"
    port: 22
    user: "root"
    password: "password"   # 或使用 key_file
    # key_file: "/path/to/private_key"

ftp_servers:
  ftp1:
    host: "192.168.1.101"
    port: 21
    user: "ftpuser"
    password: "ftppass"

encoding:
  default: "base64"       # 默认使用base64编码
  
log:
  level: "debug"          # 测试环境使用debug级别
  file: "server.log"
```

### 3. 快速启停
```bash
./start.sh    # 启动服务
./status.sh   # 查看状态
./stop.sh     # 停止服务

# 查看日志
tail -f server.log
```

### 4. 测试验证
```bash
# 健康检查
curl http://localhost:8080/api/health

# 测试SSH命令（Base64编码）
curl -X POST http://localhost:8080/api/ssh/exec \
  -H "Content-Type: application/json" \
  -d '{
    "server": "server1",
    "command": "bHMgLWxh",
    "encoding": "base64"
  }'

# WebSocket测试（使用wscat）
wscat -c ws://localhost:8081/ws/ssh
```

---

## 开发路径（渐进式）

### 第一阶段：核心功能（MVP）

**目标**：快速实现可用的SSH/FTP代理

- [ ] HTTP服务器基础框架（Gin）
- [ ] **Base64编解码模块**（核心）
- [ ] SSH命令执行（/api/ssh/exec）
- [ ] FTP基础操作（列表、上传、下载）
- [ ] 多服务器配置支持
- [ ] 基础日志记录
- [ ] **启停脚本**（start.sh, stop.sh, status.sh）

**验收标准**：
- ✅ 能通过HTTP API执行SSH命令并返回结果
- ✅ 支持Base64编码的复杂命令
- ✅ 能进行基础FTP文件操作
- ✅ 一键启停正常工作

### 第二阶段：WebSocket支持（高性能通讯）

**目标**：增加实时通讯能力

- [ ] **WebSocket服务器**（/ws/ssh, /ws/ftp）
- [ ] SSH交互式会话（实时输入输出）
- [ ] 流式命令输出
- [ ] WebSocket消息编解码
- [ ] 连接管理和超时控制

**验收标准**：
- ✅ WebSocket连接稳定
- ✅ 能实时查看长时间运行命令的输出
- ✅ 支持交互式命令序列

### 第三阶段：优化增强（可选）

**目标**：提升性能和易用性

- [ ] SSH/FTP连接池
- [ ] 文件传输进度回调
- [ ] 断点续传
- [ ] 配置热重载
- [ ] 性能监控接口

---

## 已明确的设计决策 ✅

基于用户反馈，以下设计已确定：

### 1. 使用场景
✅ **临时测试调试工具**，追求快速启停和易用性  
✅ **不需要复杂安全机制**（仅内网或测试环境使用）  
✅ **需要一键启停脚本**（start.sh, stop.sh, status.sh）

### 2. 核心功能
✅ **SSH命令执行是重点**（`/api/ssh/exec`）  
✅ **必须使用Base64编码**处理复杂命令  
✅ **同时支持HTTP和WebSocket**两种通讯协议  
✅ **FTP功能同样需要Base64编码支持**

### 3. 技术选型
✅ **Go语言**编译为独立二进制  
✅ **HTTP + WebSocket** 双协议支持  
✅ **显式IP绑定**（遵循用户规则）

---

## 已确认的技术细节 ✅

### 1. 服务器配置
✅ **目标服务器**：单个服务器
✅ **凭据存储**：配置文件 + 环境变量覆盖
✅ **SSH认证**：支持密码和密钥

### 2. 端口与绑定
✅ **HTTP端口**：`48891`
✅ **WebSocket端口**：`48892`
✅ **绑定IP**：`0.0.0.0`

### 3. 功能优先级
✅ **分段式开发**：核心功能 -> 完善功能
✅ **MVP范围**：优先实现HTTP上的SSH执行
✅ **WebSocket**：后续阶段实现

### 4. 编码策略
✅ **Base64**：**强制使用**（输入和输出）
✅ **错误信息**：也使用Base64编码

---

## 风险与注意事项

### 安全风险
⚠️ **命令注入**：必须严格验证和过滤用户输入
⚠️ **凭证泄露**：配置文件权限设置为600
⚠️ **未授权访问**：必须实现认证机制
⚠️ **日志敏感信息**：避免在日志中记录密码

### 技术风险
⚠️ **连接泄露**：确保SSH/FTP连接正确关闭
⚠️ **内存泄露**：长期运行需监控内存使用
⚠️ **超时处理**：避免长时间运行的命令阻塞服务
⚠️ **错误恢复**：网络异常时的重试和恢复机制

### 运维风险
⚠️ **服务单点**：考虑高可用部署
⚠️ **日志膨胀**：实现日志轮转和清理
⚠️ **性能瓶颈**：监控并优化慢请求

---

## 总结

本方案通过构建Go语言的HTTP代理服务，为AI Agent提供了一个简洁、安全、易用的SSH/FTP操作接口。核心优势在于：

1. **简化集成**：统一的RESTful API，降低AI Agent的集成复杂度
2. **安全可控**：集中式凭证管理和操作审计
3. **功能完整**：支持命令执行、文件传输、结果获取等完整功能
4. **扩展性强**：易于添加新功能和支持更多协议

建议采用**渐进式开发**策略，先实现MVP版本验证核心功能，再逐步增强。在开发过程中，严格遵循安全最佳实践，确保服务的稳定性和安全性。

---

**文档版本**：v1.0  
**创建时间**：2026-01-17  
**状态**：待评审
